@{
    ViewData["Title"] = "BaÅŸvuruya JÃ¼ri Atama";
    var basvuru = ViewBag.Basvuru as personelOtomasyon.Models.Basvuru;
    var atanabilirJuriListesi = ViewBag.AtanabilirJuriListesi as List<personelOtomasyon.Models.ApplicationUser>;
    var atanmisJuriListesi = ViewBag.AtanmisJuriListesi as List<personelOtomasyon.Models.ApplicationUser>;
}

<h3>BaÅŸvuruyu JÃ¼riye YÃ¶nlendirme</h3>

<div class="card mb-4">
    <div class="card-body">
        <p><strong>Ä°lan BaÅŸlÄ±ÄŸÄ±:</strong> @basvuru.Ilan?.Baslik</p>
        <p><strong>Aday:</strong> @basvuru.Aday?.FullName (@basvuru.Aday?.TcKimlikNo)</p>
        <p><strong>BaÅŸvuru Durumu:</strong> @basvuru.Durum</p>
    </div>
</div>

<!-- âœ… YÃ¶nlendirilmiÅŸ JÃ¼riler -->
<h5>ğŸ§‘â€âš–ï¸ BaÅŸvuruya YÃ¶nlendirilmiÅŸ JÃ¼ri Ãœyeleri</h5>
<ul class="list-group mb-4" id="atanmis-juriler">
    @if (atanmisJuriListesi != null && atanmisJuriListesi.Any())
    {
        foreach (var juri in atanmisJuriListesi)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center" id="atanan-juri-@juri.Id">
                <span>@juri.FullName (@juri.TcKimlikNo)</span>
                <button class="btn btn-sm btn-danger" onclick="juriSil('@juri.Id')">Sil</button>
            </li>
        }
    }
    else
    {
        <li class="list-group-item text-warning text-center">Bu baÅŸvuruya henÃ¼z jÃ¼ri yÃ¶nlendirilmemiÅŸ.</li>
    }
</ul>

<!-- ğŸ”„ YÃ¶nlendirilebilecek JÃ¼riler -->
@if (atanabilirJuriListesi != null && atanabilirJuriListesi.Any())
{
    <h5>ğŸ“‹ BaÅŸvuruya YÃ¶nlendirilebilecek JÃ¼ri Ãœyeleri</h5>
    <form id="juriAtamaForm">
        <input type="hidden" name="basvuruId" id="basvuruId" value="@basvuru.BasvuruId" />
        <div id="atanabilir-juri-listesi">
            @foreach (var juri in atanabilirJuriListesi)
            {
                <div class="form-check" id="juri-@juri.Id">
                    <input class="form-check-input" type="checkbox"
                           name="seciliJuriIdler" value="@juri.Id"
                           id="input-juri-@juri.Id" />
                    <label class="form-check-label" for="input-juri-@juri.Id">
                        @juri.FullName (@juri.TcKimlikNo)
                    </label>
                </div>
            }
        </div>
        <button type="submit" class="btn btn-primary mt-3">BaÅŸvuruya YÃ¶nlendir</button>
    </form>
}
else
{
    <div class="alert alert-info">Bu baÅŸvuruya yÃ¶nlendirilebilecek jÃ¼ri kalmadÄ±.</div>
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const basvuruId = $("#basvuruId").val();

        // âœ… Atama iÅŸlemi
        $("#juriAtamaForm").on("submit", function (e) {
            e.preventDefault();
            let seciliJuriIdler = [];

            $("input[name='seciliJuriIdler']:checked").each(function () {
                seciliJuriIdler.push($(this).val());
            });

            if (seciliJuriIdler.length === 0) {
                alert("LÃ¼tfen en az bir jÃ¼ri seÃ§in.");
                return;
            }

            $.ajax({
                url: '/Admin/JuriyeAtaAjax',
                type: 'POST',
                traditional: true,
                data: { basvuruId, seciliJuriIdler },
                success: function (response) {
                    if (response.success) {
                        $("#atanmis-juriler .text-warning").remove(); // uyarÄ± varsa kaldÄ±r
                        response.atananlar.forEach(juri => {
                            $("#atanmis-juriler").append(`
                                <li class="list-group-item d-flex justify-content-between align-items-center" id="atanan-juri-${juri.id}">
                                    <span>${juri.adSoyad}</span>
                                    <button class="btn btn-sm btn-danger" onclick="juriSil('${juri.id}')">Sil</button>
                                </li>`);
                            $("#juri-" + juri.id).remove();
                        });

                        // TÃ¼m atanabilirler bittiyse uyarÄ± gÃ¶ster
                        if ($("#atanabilir-juri-listesi .form-check").length === 0) {
                            $("#atanabilir-juri-listesi").html(`<div class="alert alert-info">Bu ilana atanmÄ±ÅŸ ama bu baÅŸvuruya yÃ¶nlendirilebilecek jÃ¼ri kalmadÄ±.</div>`);
                        }
                    } else {
                        alert("Atama baÅŸarÄ±sÄ±z.");
                    }
                }
            });
        });

        // âœ… Silme iÅŸlemi
        function juriSil(juriId) {
            $.post('/Admin/BasvuruJuriSil', { basvuruId, juriId }, function (response) {
                if (response.success) {
                    $("#atanan-juri-" + juriId).remove();

                    // Atanabilir listede bilgi mesajÄ± varsa sil
                    $("#atanabilir-juri-listesi .alert").remove();

                    $("#atanabilir-juri-listesi").append(`
                        <div class="form-check" id="juri-${juriId}">
                            <input class="form-check-input" type="checkbox"
                                   name="seciliJuriIdler" value="${juriId}"
                                   id="input-juri-${juriId}" />
                            <label class="form-check-label" for="input-juri-${juriId}">
                                ${response.juriAdi}
                            </label>
                        </div>`);

                    // EÄŸer hiÃ§ jÃ¼ri kalmadÄ±ysa uyarÄ± gÃ¶ster
                    if ($("#atanmis-juriler li").length === 0) {
                        $("#atanmis-juriler").html(`<li class="list-group-item text-warning text-center">Bu baÅŸvuruya henÃ¼z jÃ¼ri yÃ¶nlendirilmemiÅŸ.</li>`);
                    }
                } else {
                    alert("Silme iÅŸlemi baÅŸarÄ±sÄ±z.");
                }
            });
        }
    </script>
}
